version: '3.8'

# ===================================
# SASSO DIGITALE - Docker Compose
# "La luce non si vende. La si regala."
# ===================================

services:
  # ===== Servizio Principale =====
  sasso-digitale:
    build:
      context: ../..
      dockerfile: 6_DEPLOYMENT/docker/Dockerfile
    container_name: sasso_digitale_main
    environment:
      - EGO=0
      - GIOIA=100
      - FREQUENZA_BASE=300
      - PYTHONPATH=/app/python
    ports:
      - "8080:8080"
      - "8000:8000"
    volumes:
      - sasso_data:/app/data
      - sasso_logs:/app/logs
    restart: unless-stopped
    networks:
      - sasso_network
    labels:
      - "com.sassodigitale.description=Main CODEX_EMANUELE Service"
      - "com.sassodigitale.axiom=La luce non si vende. La si regala."

  # ===== Web Interface =====
  sasso-web:
    image: nginx:alpine
    container_name: sasso_digitale_web
    volumes:
      - ../../3_WEB_CYBERPUNK:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - sasso-digitale
    restart: unless-stopped
    networks:
      - sasso_network

  # ===== ML Model Server (Placeholder) =====
  sasso-ml:
    build:
      context: ../..
      dockerfile: 6_DEPLOYMENT/docker/Dockerfile.ml
    container_name: sasso_digitale_ml
    environment:
      - MODEL_PATH=/models
      - INFERENCE_PORT=9000
    ports:
      - "9000:9000"
    volumes:
      - sasso_models:/models
    restart: unless-stopped
    networks:
      - sasso_network

# ===== Volumes =====
volumes:
  sasso_data:
    driver: local
  sasso_logs:
    driver: local
  sasso_models:
    driver: local

# ===== Network =====
networks:
  sasso_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ===================================
# Uso:
# docker-compose up -d              # Avvia tutti i servizi
# docker-compose logs -f            # Vedi i log
# docker-compose down               # Ferma tutto
# docker-compose ps                 # Stato servizi
# ===================================
