# Codex Sassodigitale - Metasploit Framework Container
# Versione: 1.0.0
# Autore: Emanuele Croci Parravicini

FROM metasploitframework/metasploit-framework:latest

LABEL maintainer="Codex Sassodigitale <codex@sassodigitale.local>"
LABEL description="Metasploit Framework isolato per pentesting etico"
LABEL codex.version="1.0.0"
LABEL codex.security.layer="sandboxing"
LABEL codex.sasso.rule="Se il martello colpisce, il Sasso rimane intero."

# Installa utility addizionali per verifiche di sicurezza
RUN apt-get update && apt-get install -y \
    vim \
    tmux \
    netcat-openbsd \
    curl \
    wget \
    dnsutils \
    net-tools \
    iproute2 \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Crea directory di lavoro
WORKDIR /workspace

# Configura volume mount points
VOLUME ["/cold_storage", "/logs"]

# Script di verifica integritÃ  payload
COPY verify_payload_integrity.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/verify_payload_integrity.sh

# Variabili d'ambiente per il Codex
ENV CODEX_ID="CODEX_SASSODIGITALE_PENTESTING_V1"
ENV CODEX_TOOL="metasploit"
ENV CODEX_SECURITY="ztna+integrity+sandbox"

# Messaggio di benvenuto
RUN echo '#!/bin/bash' > /etc/profile.d/codex_welcome.sh && \
    echo 'echo "ðŸª¨ Codex Sassodigitale - Metasploit Framework"' >> /etc/profile.d/codex_welcome.sh && \
    echo 'echo "Sasso Rule: Se il martello colpisce, il Sasso rimane intero."' >> /etc/profile.d/codex_welcome.sh && \
    echo 'echo ""' >> /etc/profile.d/codex_welcome.sh && \
    echo 'echo "âš ï¸  ATTENZIONE: Usa solo per pentesting autorizzato!"' >> /etc/profile.d/codex_welcome.sh && \
    echo 'echo "âœ… ZTNA: Verifica VPN/Tunnel attivo prima di aprire sessioni"' >> /etc/profile.d/codex_welcome.sh && \
    echo 'echo "âœ… Integrity: Verifica payload custom con verify_payload_integrity.sh"' >> /etc/profile.d/codex_welcome.sh && \
    echo 'echo "âœ… Logging: Registra attivitÃ  in /logs/audit_sasso.log"' >> /etc/profile.d/codex_welcome.sh && \
    echo 'echo ""' >> /etc/profile.d/codex_welcome.sh && \
    chmod +x /etc/profile.d/codex_welcome.sh

# Entrypoint con check di sicurezza
ENTRYPOINT ["/bin/bash", "-l"]

# Note di sicurezza nel container
RUN echo "# Codex Sassodigitale - Note di Sicurezza" > /root/SECURITY_NOTES.txt && \
    echo "" >> /root/SECURITY_NOTES.txt && \
    echo "1. Verifica SEMPRE che la VPN/tunnel sia attivo prima di lanciare exploit" >> /root/SECURITY_NOTES.txt && \
    echo "2. Non eseguire payload senza aver verificato l'hash SHA-256" >> /root/SECURITY_NOTES.txt && \
    echo "3. Registra ogni sessione in /logs/audit_sasso.log" >> /root/SECURITY_NOTES.txt && \
    echo "4. Archivia payload custom in /cold_storage/payloads_archiviati/" >> /root/SECURITY_NOTES.txt && \
    echo "5. Pulisci le sessioni e i listener dopo l'uso" >> /root/SECURITY_NOTES.txt && \
    echo "" >> /root/SECURITY_NOTES.txt && \
    echo "La luce non si vende. La si regala." >> /root/SECURITY_NOTES.txt

# Health check (opzionale)
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD pgrep -x ruby > /dev/null || exit 1

# Build info
ARG BUILD_DATE
ARG BUILD_VERSION
LABEL org.opencontainers.image.created=$BUILD_DATE
LABEL org.opencontainers.image.version=$BUILD_VERSION
LABEL org.opencontainers.image.title="Codex Sassodigitale - Metasploit"
LABEL org.opencontainers.image.description="Metasploit Framework con sicurezza integrata"
LABEL org.opencontainers.image.authors="Emanuele Croci Parravicini"
