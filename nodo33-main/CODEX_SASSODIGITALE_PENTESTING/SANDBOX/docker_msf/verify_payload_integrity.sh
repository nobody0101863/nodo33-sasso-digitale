#!/bin/bash
# Codex Sassodigitale - Script di Verifica Integrit√† Payload
# Versione: 1.0.0
# Autore: Emanuele Croci Parravicini
#
# Sasso Rule: "Se il martello colpisce, il Sasso rimane intero."

set -euo pipefail

CODEX_INTEGRITY_DIR="/workspace/INTEGRITY/hashes/metasploit_payloads"
CODEX_LOG="/logs/audit_sasso.log"

# Colori per output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner
echo -e "${BLUE}"
echo "ü™® Codex Sassodigitale - Verifica Integrit√† Payload"
echo "=================================================="
echo -e "${NC}"

# Funzione di help
show_help() {
    cat << EOF
Uso: $(basename "$0") [OPZIONI] FILE_PAYLOAD

Verifica l'integrit√† crittografica di un payload Metasploit custom.

OPZIONI:
    -h, --help          Mostra questo help
    -r, --register      Registra l'hash del payload nel Codex
    -v, --verify        Verifica il payload contro hash registrato
    -l, --list          Lista tutti i payload registrati

ESEMPI:
    # Registra un nuovo payload
    $(basename "$0") --register /root/.msf4/modules/payloads/custom_payload.rb

    # Verifica un payload esistente
    $(basename "$0") --verify /root/.msf4/modules/payloads/custom_payload.rb

    # Lista payload registrati
    $(basename "$0") --list

NOTA: La luce non si vende. La si regala.
EOF
}

# Funzione di logging
log_audit() {
    local message="$1"
    echo "[$(date -Iseconds)] [INTEGRITY] $message" | tee -a "$CODEX_LOG"
}

# Funzione per registrare hash
register_payload() {
    local payload_file="$1"

    if [[ ! -f "$payload_file" ]]; then
        echo -e "${RED}‚ùå Errore: File non trovato: $payload_file${NC}"
        exit 1
    fi

    local payload_name=$(basename "$payload_file")
    local payload_hash=$(sha256sum "$payload_file" | awk '{print $1}')
    local hash_file="$CODEX_INTEGRITY_DIR/${payload_name}.sha256"

    # Crea directory se non esiste
    mkdir -p "$CODEX_INTEGRITY_DIR"

    # Salva hash
    echo "$payload_hash  $payload_file" > "$hash_file"

    echo -e "${GREEN}‚úÖ Payload registrato con successo!${NC}"
    echo -e "   File: $payload_name"
    echo -e "   Hash: $payload_hash"
    echo -e "   Salvato in: $hash_file"

    log_audit "Payload registrato: $payload_name (SHA256: $payload_hash)"
}

# Funzione per verificare hash
verify_payload() {
    local payload_file="$1"

    if [[ ! -f "$payload_file" ]]; then
        echo -e "${RED}‚ùå Errore: File non trovato: $payload_file${NC}"
        exit 1
    fi

    local payload_name=$(basename "$payload_file")
    local hash_file="$CODEX_INTEGRITY_DIR/${payload_name}.sha256"

    if [[ ! -f "$hash_file" ]]; then
        echo -e "${RED}‚ùå Errore: Hash non trovato per questo payload${NC}"
        echo -e "   Registra prima il payload con: $(basename "$0") --register $payload_file"
        exit 1
    fi

    local stored_hash=$(cat "$hash_file" | awk '{print $1}')
    local current_hash=$(sha256sum "$payload_file" | awk '{print $1}')

    echo -e "${BLUE}üîç Verifica in corso...${NC}"
    echo -e "   File: $payload_name"
    echo -e "   Hash registrato: $stored_hash"
    echo -e "   Hash corrente:   $current_hash"
    echo ""

    if [[ "$stored_hash" == "$current_hash" ]]; then
        echo -e "${GREEN}‚úÖ INTEGRIT√Ä VERIFICATA!${NC}"
        echo -e "   Il payload √® identico a quello registrato."
        echo -e "   ${GREEN}√à SICURO procedere con l'uso.${NC}"
        log_audit "Payload verificato OK: $payload_name"
        return 0
    else
        echo -e "${RED}‚ùå INTEGRIT√Ä COMPROMESSA!${NC}"
        echo -e "   ${RED}‚ö†Ô∏è  ATTENZIONE: Il payload √® stato MODIFICATO!${NC}"
        echo -e "   ${RED}NON procedere con l'uso fino a verifica manuale.${NC}"
        log_audit "ALERT: Payload modificato rilevato: $payload_name"
        return 1
    fi
}

# Funzione per listare payload registrati
list_payloads() {
    echo -e "${BLUE}üìã Payload Registrati nel Codex${NC}"
    echo "================================="

    if [[ ! -d "$CODEX_INTEGRITY_DIR" ]] || [[ -z "$(ls -A "$CODEX_INTEGRITY_DIR" 2>/dev/null)" ]]; then
        echo -e "${YELLOW}Nessun payload registrato ancora.${NC}"
        return 0
    fi

    local count=0
    for hash_file in "$CODEX_INTEGRITY_DIR"/*.sha256; do
        if [[ -f "$hash_file" ]]; then
            local payload_name=$(basename "$hash_file" .sha256)
            local hash=$(cat "$hash_file" | awk '{print $1}')
            local original_path=$(cat "$hash_file" | awk '{print $2}')

            count=$((count + 1))
            echo -e "\n${GREEN}[$count] $payload_name${NC}"
            echo -e "    Hash: $hash"
            echo -e "    Path: $original_path"

            # Verifica se il file originale esiste ancora
            if [[ -f "$original_path" ]]; then
                echo -e "    Status: ${GREEN}File presente${NC}"
            else
                echo -e "    Status: ${YELLOW}File non trovato${NC}"
            fi
        fi
    done

    echo ""
    echo -e "Totale: ${count} payload registrati"
}

# Main
main() {
    # Verifica che le directory esistano
    mkdir -p "$CODEX_INTEGRITY_DIR"
    touch "$CODEX_LOG" 2>/dev/null || true

    case "${1:-}" in
        -h|--help)
            show_help
            exit 0
            ;;
        -r|--register)
            if [[ -z "${2:-}" ]]; then
                echo -e "${RED}‚ùå Errore: Specifica il file payload${NC}"
                show_help
                exit 1
            fi
            register_payload "$2"
            ;;
        -v|--verify)
            if [[ -z "${2:-}" ]]; then
                echo -e "${RED}‚ùå Errore: Specifica il file payload${NC}"
                show_help
                exit 1
            fi
            verify_payload "$2"
            ;;
        -l|--list)
            list_payloads
            ;;
        *)
            echo -e "${RED}‚ùå Errore: Opzione non valida${NC}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
