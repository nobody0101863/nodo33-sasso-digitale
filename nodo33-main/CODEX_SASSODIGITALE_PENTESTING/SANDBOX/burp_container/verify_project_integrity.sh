#!/bin/bash
# Codex Sassodigitale - Script di Verifica Integrit√† Progetti Burp
# Versione: 1.0.0
# Autore: Emanuele Croci Parravicini
#
# Sasso Rule: "Chi cattura il vento deve chiuderlo nel vaso."

set -euo pipefail

CODEX_INTEGRITY_DIR="/workspace/INTEGRITY/hashes/burp_projects"
CODEX_LOG="/logs/audit_sasso.log"

# Colori per output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner
echo -e "${BLUE}"
echo "ü™® Codex Sassodigitale - Verifica Integrit√† Progetti Burp"
echo "=========================================================="
echo -e "${NC}"

# Funzione di help
show_help() {
    cat << EOF
Uso: $(basename "$0") [OPZIONI] FILE_PROGETTO

Verifica l'integrit√† crittografica di un file progetto Burp Suite (.burp).

OPZIONI:
    -h, --help          Mostra questo help
    -r, --register      Registra l'hash del progetto nel Codex
    -v, --verify        Verifica il progetto contro hash registrato
    -l, --list          Lista tutti i progetti registrati

ESEMPI:
    # Registra un nuovo progetto
    $(basename "$0") --register /cold_storage/burp_secure_projects/my_test.burp

    # Verifica un progetto esistente
    $(basename "$0") --verify /cold_storage/burp_secure_projects/my_test.burp

    # Lista progetti registrati
    $(basename "$0") --list

NOTA: La luce non si vende. La si regala.
EOF
}

# Funzione di logging
log_audit() {
    local message="$1"
    echo "[$(date -Iseconds)] [INTEGRITY] $message" | tee -a "$CODEX_LOG"
}

# Funzione per registrare hash
register_project() {
    local project_file="$1"

    if [[ ! -f "$project_file" ]]; then
        echo -e "${RED}‚ùå Errore: File non trovato: $project_file${NC}"
        exit 1
    fi

    # Verifica che sia un file .burp
    if [[ ! "$project_file" =~ \.burp(\.gpg)?$ ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Attenzione: Il file non ha estensione .burp o .burp.gpg${NC}"
        read -p "Continuare comunque? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi

    local project_name=$(basename "$project_file")
    local project_hash=$(sha256sum "$project_file" | awk '{print $1}')
    local hash_file="$CODEX_INTEGRITY_DIR/${project_name}.sha256"

    # Crea directory se non esiste
    mkdir -p "$CODEX_INTEGRITY_DIR"

    # Salva hash con metadati
    cat > "$hash_file" <<EOF
# Codex Sassodigitale - Hash Progetto Burp
# Registrato: $(date -Iseconds)
# File: $project_file
$project_hash  $project_file
EOF

    echo -e "${GREEN}‚úÖ Progetto registrato con successo!${NC}"
    echo -e "   File: $project_name"
    echo -e "   Hash: $project_hash"
    echo -e "   Salvato in: $hash_file"

    log_audit "Progetto Burp registrato: $project_name (SHA256: $project_hash)"

    # Suggerisci cifratura se non gi√† cifrato
    if [[ ! "$project_file" =~ \.gpg$ ]]; then
        echo ""
        echo -e "${YELLOW}üí° Suggerimento: Cifra ora il progetto${NC}"
        echo -e "   gpg --symmetric --cipher-algo AES256 \"$project_file\""
        echo -e "   shred -u \"$project_file\""
    fi
}

# Funzione per verificare hash
verify_project() {
    local project_file="$1"

    if [[ ! -f "$project_file" ]]; then
        echo -e "${RED}‚ùå Errore: File non trovato: $project_file${NC}"
        exit 1
    fi

    local project_name=$(basename "$project_file")
    local hash_file="$CODEX_INTEGRITY_DIR/${project_name}.sha256"

    if [[ ! -f "$hash_file" ]]; then
        echo -e "${RED}‚ùå Errore: Hash non trovato per questo progetto${NC}"
        echo -e "   Registra prima il progetto con: $(basename "$0") --register $project_file"
        exit 1
    fi

    local stored_hash=$(grep -v "^#" "$hash_file" | awk '{print $1}')
    local current_hash=$(sha256sum "$project_file" | awk '{print $1}')

    echo -e "${BLUE}üîç Verifica in corso...${NC}"
    echo -e "   File: $project_name"
    echo -e "   Hash registrato: $stored_hash"
    echo -e "   Hash corrente:   $current_hash"
    echo ""

    if [[ "$stored_hash" == "$current_hash" ]]; then
        echo -e "${GREEN}‚úÖ INTEGRIT√Ä VERIFICATA!${NC}"
        echo -e "   Il progetto √® identico a quello registrato."
        echo -e "   ${GREEN}√à SICURO procedere con l'uso.${NC}"
        log_audit "Progetto Burp verificato OK: $project_name"
        return 0
    else
        echo -e "${RED}‚ùå INTEGRIT√Ä COMPROMESSA!${NC}"
        echo -e "   ${RED}‚ö†Ô∏è  ATTENZIONE: Il progetto √® stato MODIFICATO!${NC}"
        echo -e "   ${RED}NON procedere con l'uso fino a verifica manuale.${NC}"
        log_audit "ALERT: Progetto Burp modificato rilevato: $project_name"
        return 1
    fi
}

# Funzione per listare progetti registrati
list_projects() {
    echo -e "${BLUE}üìã Progetti Burp Registrati nel Codex${NC}"
    echo "======================================"

    if [[ ! -d "$CODEX_INTEGRITY_DIR" ]] || [[ -z "$(ls -A "$CODEX_INTEGRITY_DIR" 2>/dev/null)" ]]; then
        echo -e "${YELLOW}Nessun progetto registrato ancora.${NC}"
        return 0
    fi

    local count=0
    for hash_file in "$CODEX_INTEGRITY_DIR"/*.sha256; do
        if [[ -f "$hash_file" ]]; then
            local project_name=$(basename "$hash_file" .sha256)
            local hash=$(grep -v "^#" "$hash_file" | awk '{print $1}')
            local original_path=$(grep -v "^#" "$hash_file" | awk '{print $2}')
            local registered_date=$(grep "^# Registrato:" "$hash_file" | cut -d' ' -f3-)

            count=$((count + 1))
            echo -e "\n${GREEN}[$count] $project_name${NC}"
            echo -e "    Hash: $hash"
            echo -e "    Path: $original_path"
            echo -e "    Registrato: $registered_date"

            # Verifica se il file originale esiste ancora
            if [[ -f "$original_path" ]]; then
                echo -e "    Status: ${GREEN}File presente${NC}"
            elif [[ -f "${original_path}.gpg" ]]; then
                echo -e "    Status: ${BLUE}File cifrato presente${NC}"
            else
                echo -e "    Status: ${YELLOW}File non trovato${NC}"
            fi
        fi
    done

    echo ""
    echo -e "Totale: ${count} progetti registrati"
}

# Main
main() {
    # Verifica che le directory esistano
    mkdir -p "$CODEX_INTEGRITY_DIR"
    touch "$CODEX_LOG" 2>/dev/null || true

    case "${1:-}" in
        -h|--help)
            show_help
            exit 0
            ;;
        -r|--register)
            if [[ -z "${2:-}" ]]; then
                echo -e "${RED}‚ùå Errore: Specifica il file progetto${NC}"
                show_help
                exit 1
            fi
            register_project "$2"
            ;;
        -v|--verify)
            if [[ -z "${2:-}" ]]; then
                echo -e "${RED}‚ùå Errore: Specifica il file progetto${NC}"
                show_help
                exit 1
            fi
            verify_project "$2"
            ;;
        -l|--list)
            list_projects
            ;;
        *)
            echo -e "${RED}‚ùå Errore: Opzione non valida${NC}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
