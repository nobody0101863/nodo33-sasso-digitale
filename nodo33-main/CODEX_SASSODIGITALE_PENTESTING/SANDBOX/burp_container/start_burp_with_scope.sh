#!/bin/bash
# Codex Sassodigitale - Avvio Burp Suite con Scope Preconfigurato
# Versione: 1.0.0
# Autore: Emanuele Croci Parravicini
#
# Sasso Rule: "Chi cattura il vento deve chiuderlo nel vaso."

set -euo pipefail

# Colori per output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

BURP_JAR="/opt/burp/burpsuite.jar"
CODEX_LOG="/logs/audit_sasso.log"

# Banner
echo -e "${BLUE}"
echo "ðŸª¨ Codex Sassodigitale - Avvio Burp Suite"
echo "========================================="
echo -e "${NC}"

# Help
if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]] || [[ -z "${1:-}" ]]; then
    cat << EOF
Uso: $(basename "$0") TARGET_DOMAIN [PROJECT_NAME]

Avvia Burp Suite con scope preconfigurato sul dominio target.

ARGOMENTI:
    TARGET_DOMAIN    Dominio del target (es: target.example.com)
    PROJECT_NAME     Nome progetto opzionale (default: auto-generato)

ESEMPI:
    $(basename "$0") target.example.com
    $(basename "$0") target.example.com my_pentest_2025

SICUREZZA:
    - Lo scope sarÃ  limitato SOLO a: https?://TARGET_DOMAIN/.*
    - I progetti saranno salvati in: /cold_storage/burp_secure_projects/
    - Ogni avvio Ã¨ registrato in: /logs/audit_sasso.log

NOTA: La luce non si vende. La si regala.
EOF
    exit 0
fi

TARGET_DOMAIN="$1"
PROJECT_NAME="${2:-burp_$(date +%Y%m%d_%H%M%S)_${TARGET_DOMAIN//[^a-zA-Z0-9]/_}}"

# Verifica che Burp JAR esista
if [[ ! -f "$BURP_JAR" ]]; then
    echo -e "${RED}âŒ Errore: Burp Suite JAR non trovato in $BURP_JAR${NC}"
    echo -e "${YELLOW}Vedi /root/BURP_SETUP.txt per istruzioni di setup${NC}"
    exit 1
fi

# Crea directory progetto
PROJECT_DIR="/cold_storage/burp_secure_projects"
mkdir -p "$PROJECT_DIR"

PROJECT_FILE="$PROJECT_DIR/${PROJECT_NAME}.burp"

# Log audit
echo "[$(date -Iseconds)] [BURP] Avvio Burp Suite per target: $TARGET_DOMAIN (Progetto: $PROJECT_NAME)" | tee -a "$CODEX_LOG"

# Crea configurazione scope JSON per Burp
SCOPE_CONFIG=$(cat <<EOF
{
  "target": {
    "scope": {
      "advanced_mode": true,
      "exclude": [],
      "include": [
        {
          "enabled": true,
          "protocol": "any",
          "host": "^${TARGET_DOMAIN//./\\.}$"
        }
      ]
    }
  }
}
EOF
)

# Salva scope config
SCOPE_FILE="/tmp/burp_scope_${TARGET_DOMAIN}.json"
echo "$SCOPE_CONFIG" > "$SCOPE_FILE"

echo -e "${GREEN}âœ… Configurazione scope creata${NC}"
echo -e "   Target: $TARGET_DOMAIN"
echo -e "   Progetto: $PROJECT_FILE"
echo -e "   Scope: Solo ^${TARGET_DOMAIN}\$"
echo ""

# Avvio Burp
echo -e "${BLUE}ðŸš€ Avvio Burp Suite...${NC}"
echo -e "${YELLOW}âš ï¸  Ricorda di:${NC}"
echo -e "   1. Configurare il browser per usare proxy 127.0.0.1:8080"
echo -e "   2. Verificare lo scope in Burp > Target > Scope"
echo -e "   3. Salvare il progetto al termine"
echo -e "   4. Cifrare il file .burp con GPG"
echo ""

# Nota: Burp Suite configurazione scope via command line Ã¨ limitata
# L'utente dovrÃ  configurare manualmente lo scope nella GUI
# Qui forniamo le istruzioni e il file JSON

echo -e "${YELLOW}ðŸ“‹ ISTRUZIONI SCOPE:${NC}"
echo -e "   1. In Burp, vai a Target > Scope"
echo -e "   2. Clicca 'Load' e seleziona: $SCOPE_FILE"
echo -e "   3. Verifica che solo '$TARGET_DOMAIN' sia in scope"
echo ""

# Avvia Burp
# Nota: aggiungi --config-file per configurazioni avanzate se disponibili
java -jar "$BURP_JAR" \
    --project-file="$PROJECT_FILE" \
    --use-burp-defaults

# Dopo chiusura Burp
echo ""
echo -e "${GREEN}âœ… Burp Suite chiuso${NC}"
echo ""
echo -e "${YELLOW}ðŸ”’ PASSI POST-TEST:${NC}"
echo -e "   1. Verifica hash del progetto:"
echo -e "      verify_project_integrity.sh --register \"$PROJECT_FILE\""
echo ""
echo -e "   2. Cifra il progetto:"
echo -e "      gpg --symmetric --cipher-algo AES256 \"$PROJECT_FILE\""
echo ""
echo -e "   3. Elimina il file .burp in chiaro:"
echo -e "      shred -u \"$PROJECT_FILE\""
echo ""
echo -e "   4. Log completato:"
echo -e "      tail -f /logs/audit_sasso.log"
echo ""

# Log chiusura
echo "[$(date -Iseconds)] [BURP] Sessione Burp Suite terminata: $TARGET_DOMAIN" | tee -a "$CODEX_LOG"
